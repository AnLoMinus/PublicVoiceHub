name: ğŸ“Š Generate Reports

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate weekly report
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            // Categorize issues
            const categories = {
              '×ª×—×‘×•×¨×”': 0,
              '×‘×¨×™××•×ª': 0,
              '×—×™× ×•×š': 0,
              '×¨×•×•×—×”': 0,
              '×¡×‘×™×‘×”': 0,
              '×‘×™×˜×—×•×Ÿ': 0,
              '×“×™×•×¨': 0,
              '×××©×œ': 0
            };
            
            issues.forEach(issue => {
              const body = issue.body.toLowerCase();
              if (body.includes('×ª×—×‘×•×¨×”')) categories['×ª×—×‘×•×¨×”']++;
              if (body.includes('×‘×¨×™××•×ª')) categories['×‘×¨×™××•×ª']++;
              if (body.includes('×—×™× ×•×š')) categories['×—×™× ×•×š']++;
              if (body.includes('×¨×•×•×—×”')) categories['×¨×•×•×—×”']++;
              if (body.includes('×¡×‘×™×‘×”')) categories['×¡×‘×™×‘×”']++;
              if (body.includes('×‘×™×˜×—×•×Ÿ')) categories['×‘×™×˜×—×•×Ÿ']++;
              if (body.includes('×“×™×•×¨')) categories['×“×™×•×¨']++;
              if (body.includes('×××©×œ')) categories['×××©×œ']++;
            });
            
            // Generate report
            const report = `# ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - FixCry
            
            **×ª××¨×™×š:** ${new Date().toLocaleDateString('he-IL')}
            **×ª×§×•×¤×”:** ×©×‘×•×¢ ×”××—×¨×•×Ÿ
            
            ## ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ×œ×™×•×ª
            
            - **×ª×™×§×™× ×—×“×©×™×:** ${issues.length}
            - **×ª×™×§×™× ×¤×ª×•×—×™×:** ${issues.filter(i => i.state === 'open').length}
            - **×ª×™×§×™× ×¡×’×•×¨×™×:** ${issues.filter(i => i.state === 'closed').length}
            - **Pull Requests:** ${pulls.length}
            
            ## ğŸ·ï¸ ×—×œ×•×§×” ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª
            
            ${Object.entries(categories).map(([cat, count]) => 
              `- **${cat}:** ${count} ×ª×™×§×™×`
            ).join('\n')}
            
            ## ğŸ”¥ ×ª×™×§×™× ×“×—×•×¤×™×
            
            ${issues.filter(i => i.labels.some(l => l.name === 'urgent')).map(issue => 
              `- [${issue.title}](${issue.html_url})`
            ).join('\n') || '××™×Ÿ ×ª×™×§×™× ×“×—×•×¤×™× ×”×©×‘×•×¢'}
            
            ## âœ… ×”×™×©×’×™× ×”×©×‘×•×¢
            
            - ${issues.filter(i => i.state === 'closed').length} ×ª×™×§×™× × ×¡×’×¨×•
            - ${pulls.filter(p => p.state === 'merged').length} Pull Requests ××•×–×’×•
            - ${issues.filter(i => i.labels.some(l => l.name === 'resolved')).length} ×ª×™×§×™× × ×¤×ª×¨×•
            
            ## ğŸ“‹ ×”××œ×¦×•×ª ×œ×©×‘×•×¢ ×”×‘×
            
            - ×”××©×š ××¢×§×‘ ××—×¨ ×ª×™×§×™× ×“×—×•×¤×™×
            - ×¢×“×›×•×Ÿ ××©×ª××©×™× ×¢×œ ×”×ª×§×“××•×ª
            - ×©×™×¤×•×¨ ×ª×”×œ×™×›×™ ×˜×™×¤×•×œ
            
            ---
            
            **FixCry** - ××–×¢×§×” ×œ××¢×©×”! ğŸ•Šï¸âœ¨`;
            
            // Save report to file
            const fs = require('fs');
            const path = require('path');
            
            const reportDir = path.join(process.cwd(), 'reports', 'weekly');
            if (!fs.existsSync(reportDir)) {
              fs.mkdirSync(reportDir, { recursive: true });
            }
            
            const reportFile = path.join(reportDir, `weekly-report-${new Date().toISOString().split('T')[0]}.md`);
            fs.writeFileSync(reportFile, report);
            
            // Create GitHub issue with report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ×“×•×— ×©×‘×•×¢×™ - ${new Date().toLocaleDateString('he-IL')}`,
              body: report,
              labels: ['report', 'weekly', 'automated']
            });

      - name: ğŸ“ Commit report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add reports/weekly/
          git commit -m "ğŸ“Š Add weekly report for $(date +%Y-%m-%d)" || exit 0
          git push
