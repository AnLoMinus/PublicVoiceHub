name: 📊 Generate Reports

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM
  workflow_dispatch:

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 📊 Generate weekly report
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
            });
            
            // Categorize issues
            const categories = {
              'תחבורה': 0,
              'בריאות': 0,
              'חינוך': 0,
              'רווחה': 0,
              'סביבה': 0,
              'ביטחון': 0,
              'דיור': 0,
              'ממשל': 0
            };
            
            issues.forEach(issue => {
              const body = issue.body.toLowerCase();
              if (body.includes('תחבורה')) categories['תחבורה']++;
              if (body.includes('בריאות')) categories['בריאות']++;
              if (body.includes('חינוך')) categories['חינוך']++;
              if (body.includes('רווחה')) categories['רווחה']++;
              if (body.includes('סביבה')) categories['סביבה']++;
              if (body.includes('ביטחון')) categories['ביטחון']++;
              if (body.includes('דיור')) categories['דיור']++;
              if (body.includes('ממשל')) categories['ממשל']++;
            });
            
            // Generate report
            const report = `# 📊 דוח שבועי - FixCry
            
            **תאריך:** ${new Date().toLocaleDateString('he-IL')}
            **תקופה:** שבוע האחרון
            
            ## 📈 סטטיסטיקות כלליות
            
            - **תיקים חדשים:** ${issues.length}
            - **תיקים פתוחים:** ${issues.filter(i => i.state === 'open').length}
            - **תיקים סגורים:** ${issues.filter(i => i.state === 'closed').length}
            - **Pull Requests:** ${pulls.length}
            
            ## 🏷️ חלוקה לפי קטגוריות
            
            ${Object.entries(categories).map(([cat, count]) => 
              `- **${cat}:** ${count} תיקים`
            ).join('\n')}
            
            ## 🔥 תיקים דחופים
            
            ${issues.filter(i => i.labels.some(l => l.name === 'urgent')).map(issue => 
              `- [${issue.title}](${issue.html_url})`
            ).join('\n') || 'אין תיקים דחופים השבוע'}
            
            ## ✅ הישגים השבוע
            
            - ${issues.filter(i => i.state === 'closed').length} תיקים נסגרו
            - ${pulls.filter(p => p.state === 'merged').length} Pull Requests מוזגו
            - ${issues.filter(i => i.labels.some(l => l.name === 'resolved')).length} תיקים נפתרו
            
            ## 📋 המלצות לשבוע הבא
            
            - המשך מעקב אחר תיקים דחופים
            - עדכון משתמשים על התקדמות
            - שיפור תהליכי טיפול
            
            ---
            
            **FixCry** - מזעקה למעשה! 🕊️✨`;
            
            // Save report to file
            const fs = require('fs');
            const path = require('path');
            
            const reportDir = path.join(process.cwd(), 'reports', 'weekly');
            if (!fs.existsSync(reportDir)) {
              fs.mkdirSync(reportDir, { recursive: true });
            }
            
            const reportFile = path.join(reportDir, `weekly-report-${new Date().toISOString().split('T')[0]}.md`);
            fs.writeFileSync(reportFile, report);
            
            // Create GitHub issue with report
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 דוח שבועי - ${new Date().toLocaleDateString('he-IL')}`,
              body: report,
              labels: ['report', 'weekly', 'automated']
            });

      - name: 📁 Commit report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add reports/weekly/
          git commit -m "📊 Add weekly report for $(date +%Y-%m-%d)" || exit 0
          git push
